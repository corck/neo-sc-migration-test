# Neo Python Smart Contract Migration Test

This is an example repo for testing a Smart Contract migration with neo python.

## Contracts

There are two nearly similar contracts that can be imported and executed individually.
Code is base on the neo-python example contracts.

`deployed-contract.py` is the one that will be imported and migrated to a new contract.
`new-contract` is the one that we want to migrate to.

## Test setup

For testing I'm using `neo-local` repo.

### Deployment of First contract

```
# open wallet
wallet open neo-privnet.wallet

# build contract 
sc build /sc_migration_test/deployed-contract.py

# deploy contract 
sc deploy /sc_migration_test/deployed-contract.avm True False False 0710 05 --fee=0.01

# enabling sc events logging
config sc-events on

# storing something in the contract
sc invoke 0x33b03da22e8d85eb2c5de12025bf68f5d9f36e0d add ['AAA', 3] 

# getting the balance
sc invoke 0x33b03da22e8d85eb2c5de12025bf68f5d9f36e0d balance ['AAA'] 

```

### Getting Script hash of Second contract

```
# new contract
sc build /sc_migration_test/new-contract.py

# issuing deploy to get script hash (not deploying though)
sc deploy /sc_migration_test/new-contract.avm True False False 0710 05 --fee=0.01

# Grabbing the script hash from the output
{
    "hash": "0x96a3ac80cb79f6117f26d35f4166e1576a8e1bf6",
    "script": "011fc56b6a00527ac46a51527ac468164e656f2e53746f726167652e476574436f6e74657874616a52527ac46a00c30361646487646e0006616464696e67680f4e656f2e52756e74696d652e4c6f676a52c36a51c300c37c680f4e656f2e53746f726167652e476574616a53527ac46a53c36a51c351c3936a54527ac46a52c36a51c300c36a54c35272680f4e656f2e53746f726167652e507574616a54c36c7566616a00c30672656d6f7665876454006a52c36a51c300c37c680f4e656f2e53746f726167652e476574616a53527ac46a52c36a51c300c36a53c36a51c351c3945272680f4e656f2e53746f726167652e507574616a53c36a51c351c3946c7566616a00c30762616c616e6365876421006a52c36a51c300c37c680f4e656f2e53746f726167652e476574616c7566616a00c3076d69677261746587642301174d696772617465206f7065726174696f6e207374617274680f4e656f2e52756e74696d652e4c6f6701076a55527ac401056a56527ac4516a57527ac4136d6967726174656420636f6e747261637420336a58527ac403302e336a59527ac40b6c6f63616c68756d616e336a5a527ac40d6e657840656d61696c2e636f6d6a5b527ac40d74657374206d696772617465336a5c527ac46a51c300c36a55c36a56c36a57c36a58c36a59c36a5ac36a5bc36a5cc3587951795a727551727557795279597275527275567953795872755372755579547957727554727568144e656f2e436f6e74726163742e4d696772617465616a5d527ac411636f6e7472616374206d69677261746564680f4e656f2e52756e74696d652e4c6f676a5dc36c756661006c7566",
    "parameters": [
        "String",
        "Array"
    ],
    "returntype": "ByteArray"
}
```

### Migrating the deployed contract

```
sc invoke 0x33b03da22e8d85eb2c5de12025bf68f5d9f36e0d migrate ["011fc56b6a00527ac46a51527ac468164e656f2e53746f726167652e476574436f6e74657874616a52527ac46a00c30361646487646e0006616464696e67680f4e656f2e52756e74
696d652e4c6f676a52c36a51c300c37c680f4e656f2e53746f726167652e476574616a53527ac46a53c36a51c351c3936a54527ac46a52c36a51c300c36a54c35272680f4e656f2e53746f726167652e507574616a54c36c7566616a00c30672656d6f7665876454006a
52c36a51c300c37c680f4e656f2e53746f726167652e476574616a53527ac46a52c36a51c300c36a53c36a51c351c3945272680f4e656f2e53746f726167652e507574616a53c36a51c351c3946c7566616a00c30762616c616e6365876421006a52c36a51c300c37c68
0f4e656f2e53746f726167652e476574616c7566616a00c3076d69677261746587642301174d696772617465206f7065726174696f6e207374617274680f4e656f2e52756e74696d652e4c6f6701076a55527ac401056a56527ac4516a57527ac4136d69677261746564
20636f6e747261637420336a58527ac403302e336a59527ac40b6c6f63616c68756d616e336a5a527ac40d6e657840656d61696c2e636f6d6a5b527ac40d74657374206d696772617465336a5c527ac46a51c300c36a55c36a56c36a57c36a58c36a59c36a5ac36a5bc3
6a5cc3587951795a727551727557795279597275527275567953795872755372755579547957727554727568144e656f2e436f6e74726163742e4d696772617465616a5d527ac411636f6e7472616374206d69677261746564680f4e656f2e52756e74696d652e4c6f67
6a5dc36c756661006c7566"] 


# Migration fails

`[I 190412 09:21:34 EventHub:58] [test_mode][SmartContract.Execution.Fail] [4b950c6b829bcc28ce404799a0397e33f32a6285] {'type': 'Array', 'value': [{'type': 'String', 'value': "unsupported operand type(s) for +=: 'int' and 'method'"}, {'type': 'Integer', 'value': '1701667182'}]}`

neo> [I 190412 09:21:34 EventHub:62] [SmartContract.Runtime.Log][6628] [33b03da22e8d85eb2c5de12025bf68f5d9f36e0d] [tx 264ed3d246149fe735c19cea2f497d8ad6d8f3649e9ad39a9a9fbc7fd4ba599f] {'type': 'String', 'value': 'Migrate operation'}
[I 190412 09:21:34 EventHub:62] [SmartContract.Contract.Migrate][6628] [4b950c6b829bcc28ce404799a0397e33f32a6285] [tx 264ed3d246149fe735c19cea2f497d8ad6d8f3649e9ad39a9a9fbc7fd4ba599f] {'type': 'InteropInterface'}
[I 190412 09:21:34 EventHub:58] [test_mode][SmartContract.Execution.Fail] [4b950c6b829bcc28ce404799a0397e33f32a6285] {'type': 'Array', 'value': [{'type': 'String', 'value': "unsupported operand type(s) for +=: 'int' and 'method'"}, {'type': 'Integer', 'value': '1701667182'}]}
[I 190412 09:21:34 EventHub:62] [SmartContract.Contract.Destroy][6628] [33b03da22e8d85eb2c5de12025bf68f5d9f36e0d] [tx 264ed3d246149fe735c19cea2f497d8ad6d8f3649e9ad39a9a9fbc7fd4ba599f] {'type': 'InteropInterface', 'value': {'version': 0, 'hash': '0x33b03da22e8d85eb2c5de12025bf68f5d9f36e0d', 'script': '011fc56b6a00527ac46a51527ac468164e656f2e53746f726167652e476574436f6e74657874616a52527ac46a00c30361646487646e0006616464696e67680f4e656f2e52756e74696d652e4c6f676a52c36a51c300c37c680f4e656f2e53746f726167652e476574616a53527ac46a53c36a51c351c3936a54527ac46a52c36a51c300c36a54c35272680f4e656f2e53746f726167652e507574616a54c36c7566616a00c30672656d6f7665876454006a52c36a51c300c37c680f4e656f2e53746f726167652e476574616a53527ac46a52c36a51c300c36a53c36a51c351c3945272680f4e656f2e53746f726167652e507574616a53c36a51c351c3946c7566616a00c30762616c616e6365876421006a52c36a51c300c37c680f4e656f2e53746f726167652e476574616c7566616a00c3076d69677261746587641d01114d696772617465206f7065726174696f6e680f4e656f2e52756e74696d652e4c6f6701076a55527ac401056a56527ac4516a57527ac4136d6967726174656420636f6e747261637420336a58527ac403302e336a59527ac40b6c6f63616c68756d616e336a5a527ac40d6e657840656d61696c2e636f6d6a5b527ac40d74657374206d696772617465336a5c527ac46a51c300c36a55c36a56c36a57c36a58c36a59c36a5ac36a5bc36a5cc3587951795a727551727557795279597275527275567953795872755372755579547957727554727568144e656f2e436f6e74726163742e4d696772617465616a5d527ac411636f6e7472616374206d69677261746564680f4e656f2e52756e74696d652e4c6f676a5dc36c756661006c756656c56b6a00527ac46a00c3c0011487640700516c756661006c7566', 'parameters': ['String', 'Array'], 'returntype': 'ByteArray', 'name': 'ADDTest', 'code_version': '0.1', 'author': '', 'email': '', 'description': '', 'properties': {'storage': True, 'dynamic_invoke': False, 'payable': False}}}
[I 190412 09:21:34 EventHub:62] [SmartContract.Runtime.Log][6628] [33b03da22e8d85eb2c5de12025bf68f5d9f36e0d] [tx 264ed3d246149fe735c19cea2f497d8ad6d8f3649e9ad39a9a9fbc7fd4ba599f] {'type': 'String', 'value': 'contract migrated'}
[I 190412 09:21:34 EventHub:62] [SmartContract.Execution.Success][6628] [33b03da22e8d85eb2c5de12025bf68f5d9f36e0d] [tx 264ed3d246149fe735c19cea2f497d8ad6d8f3649e9ad39a9a9fbc7fd4ba599f] {'type': 'Array', 'value': [{'type': 'InteropInterface'}]}     
```

